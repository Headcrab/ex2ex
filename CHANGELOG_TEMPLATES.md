# Changelog - Поддержка Excel шаблонов

**Дата:** 8 октября 2025 г.  
**Версия:** 1.2.0

## 🎨 Новая функциональность

### Использование Excel шаблонов

Добавлена возможность использования готовых Excel файлов в качестве шаблонов для результирующих документов. Приложение автоматически определяет наличие шаблона и использует его вместо создания пустого файла.

## 📋 Изменения в коде

### Backend (main.go)

**Функция `processExcel()` - модифицирована:**

```go
// БЫЛО: Всегда создавался новый файл
destFile := excelize.NewFile()

// СТАЛО: Проверка наличия шаблона
templatePath := filepath.Join("./templates", config.OutputFilename)
var destFile *excelize.File

if _, err := os.Stat(templatePath); err == nil {
    // Используется шаблон
    destFile, err = excelize.OpenFile(templatePath)
} else {
    // Создаётся новый файл
    destFile = excelize.NewFile()
    // ... создание листов
}
```

**Добавлено логирование:**
- `Using template file: ./templates/filename.xlsx` - при использовании шаблона
- `No template found, creating new file` - при создании нового файла

## 🎯 Как это работает

### Алгоритм

1. **Загрузка конфигурации**: Читается `output_filename` из config.yaml
2. **Проверка шаблона**: Ищется файл `templates/{output_filename}`
3. **Выбор основы:**
   - Если шаблон найден → Открывается существующий файл
   - Если нет → Создаётся новый файл с указанными листами
4. **Применение маппингов**: Данные копируются в файл
5. **Сохранение**: Файл сохраняется с timestamp

### Блок-схема

```
┌─────────────────────────┐
│ Начало обработки        │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ Проверка templates/     │
│ {output_filename}       │
└───────────┬─────────────┘
            │
       ┌────┴────┐
       │         │
    ДА │         │ НЕТ
       │         │
       ▼         ▼
  ┌────────┐  ┌────────────┐
  │ Открыть│  │ Создать    │
  │ шаблон │  │ новый файл │
  └────┬───┘  └─────┬──────┘
       │            │
       │            ▼
       │      ┌───────────┐
       │      │ Создать   │
       │      │ листы     │
       │      └─────┬─────┘
       │            │
       └────────┬───┘
                │
                ▼
       ┌──────────────────┐
       │ Применить        │
       │ маппинги         │
       └────────┬─────────┘
                │
                ▼
       ┌──────────────────┐
       │ Сохранить с      │
       │ timestamp        │
       └──────────────────┘
```

## 💡 Примеры использования

### Пример 1: Простой шаблон

**Структура:**
```
templates/
  └── report.xlsx
      └── [Лист "Отчёт" с заголовком и форматированием]
```

**config.yaml:**
```yaml
output_filename: "report.xlsx"
mappings:
  - source: "Data!A1:E100"
    destination: "Отчёт!A5"
```

**Результат:** Данные вставляются в отформатированный шаблон

### Пример 2: Шаблон с формулами

**templates/финансы.xlsx содержит:**
- Формулы итогов: `=SUM(B5:B100)`
- Условное форматирование
- Графики

**config.yaml:**
```yaml
output_filename: "финансы.xlsx"
mappings:
  - source: "Transactions!A1:C500"
    destination: "Данные!A5"
```

**Результат:** Формулы автоматически пересчитываются с новыми данными

### Пример 3: Множественные листы

**templates/отчет.xlsx имеет:**
- Лист "Сводка" с дашбордом
- Лист "Детали" с таблицей
- Лист "Графики"

**Маппинги обновляют все листы:**
```yaml
mappings:
  - source: "Raw!A1:Z1000"
    destination: "Детали!A1"
  - source: "Summary!A1:E10"
    destination: "Сводка!B5"
```

## 🔄 Обратная совместимость

✅ **Полностью сохранена!**

- Если шаблон не найден, приложение работает как раньше
- Существующие конфигурации без шаблонов продолжают работать
- Никаких изменений в API или конфигурации не требуется

## 📊 Преимущества

### До (без шаблонов)

```
Исходные данные → Новый Excel → Базовое форматирование
```

❌ Нет форматирования  
❌ Нет формул  
❌ Нужно форматировать вручную  

### После (с шаблонами)

```
Исходные данные + Шаблон → Excel с форматированием
```

✅ Профессиональный вид  
✅ Формулы работают  
✅ Графики обновляются  
✅ Экономия времени  

## 🐳 Docker

Шаблоны монтируются через volume в docker-compose.yml:

```yaml
volumes:
  - ./templates:/app/templates  # Включает Excel шаблоны
  - ./config.yaml:/app/config.yaml
```

Просто добавьте файлы `.xlsx` в папку `templates/` на хосте!

## 🧪 Тестирование

### Тест 1: С шаблоном

1. Создайте `templates/test.xlsx` с форматированием
2. Настройте `output_filename: "test.xlsx"`
3. Загрузите файл
4. **Ожидается:** Результат сохраняет форматирование

**Лог:**
```
Using template file: ./templates/test.xlsx
```

### Тест 2: Без шаблона

1. Удалите файл из templates/
2. Загрузите файл
3. **Ожидается:** Создаётся новый файл

**Лог:**
```
No template found, creating new file
```

### Тест 3: Формулы

1. Шаблон содержит формулы
2. Данные вставляются в нужные ячейки
3. **Ожидается:** Формулы пересчитываются автоматически

## 🎓 Рекомендации

### ✅ Хорошие практики

1. **Именуйте ячейки и диапазоны** для надёжных формул
2. **Тестируйте шаблоны** перед production
3. **Документируйте структуру** шаблонов
4. **Храните версии** шаблонов в git

### ❌ Избегайте

1. Макросов (не поддерживаются excelize)
2. Внешних связей с другими файлами
3. Защиты паролем
4. Нестандартных расширений (.xlsm, .xlsb)

## 📝 Документация

Созданы файлы:
- **TEMPLATE_GUIDE.md** - Полное руководство по использованию шаблонов
- **README.md** - Обновлён с описанием функциональности

## 🚀 Deployment

### Локально

```bash
go build -o ex2ex.exe .
.\ex2ex.exe
```

### Docker

```bash
docker compose build
docker compose up -d
```

## 🎉 Итоги

Функциональность готова к использованию! Теперь можно создавать профессиональные Excel отчёты на основе готовых шаблонов с сохранением всего форматирования, формул и графиков.

---

**Версия:** 1.2.0  
**Дата релиза:** 8 октября 2025 г.  
**Разработчик:** GitHub Copilot
